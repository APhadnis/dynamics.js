// Generated by CoffeeScript 1.4.0
(function() {
  var App, BrowserSupport, Graph, Tools, UIProperty, UISlider,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  BrowserSupport = (function() {

    function BrowserSupport() {}

    BrowserSupport.transform = function() {
      return this.withPrefix("transform");
    };

    BrowserSupport.keyframes = function() {
      if (document.body.style.webkitAnimation !== void 0) {
        return "-webkit-keyframes";
      }
      if (document.body.style.mozAnimation !== void 0) {
        return "-moz-keyframes";
      }
      return "keyframes";
    };

    BrowserSupport.withPrefix = function(property) {
      var prefix;
      prefix = this.prefixFor(property);
      if (prefix !== '') {
        return "-" + (prefix.toLowerCase()) + "-" + property;
      }
      return property;
    };

    BrowserSupport.prefixFor = function(property) {
      var k, prefix, prop, propArray, propertyName, _i, _j, _len, _len1, _ref;
      propArray = property.split('-');
      propertyName = "";
      for (_i = 0, _len = propArray.length; _i < _len; _i++) {
        prop = propArray[_i];
        propertyName += prop.substring(0, 1).toUpperCase() + prop.substring(1);
      }
      _ref = ["Webkit", "Moz"];
      for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
        prefix = _ref[_j];
        k = prefix + propertyName;
        if (document.body.style[k] !== void 0) {
          return prefix;
        }
      }
      return '';
    };

    return BrowserSupport;

  })();

  Graph = (function() {

    function Graph(canvas) {
      this._drawCurve = __bind(this._drawCurve, this);

      this.canvasMouseUp = __bind(this.canvasMouseUp, this);

      this.canvasMouseMove = __bind(this.canvasMouseMove, this);

      this.canvasMouseDown = __bind(this.canvasMouseDown, this);

      this.pointFromLocation = __bind(this.pointFromLocation, this);

      this.isLocationAroundCenter = __bind(this.isLocationAroundCenter, this);

      this.locationFromEvent = __bind(this.locationFromEvent, this);

      this.draw = __bind(this.draw, this);
      this.points = null;
      this.tween = null;
      this.canvas = canvas;
      this.ctx = canvas.getContext('2d');
      this.r = window.devicePixelRatio || 1;
      if (this.r) {
        canvas.width = canvas.width * this.r;
        canvas.height = canvas.height * this.r;
        canvas.style[BrowserSupport.prefixFor('transform-origin') + 'TransformOrigin'] = "0 0";
        canvas.style[BrowserSupport.prefixFor('transform') + 'Transform'] = 'scale(' + (1 / this.r) + ')';
      }
      this.canvas.addEventListener('mousedown', this.canvasMouseDown);
      this.canvas.addEventListener('mousemove', this.canvasMouseMove);
      this.canvas.addEventListener('mouseup', this.canvasMouseUp);
    }

    Graph.prototype.draw = function() {
      var args, color, colorI, colors, controlPoint, coords, coordsControlPoint, defaultColor, graph, graphes, h, i, point, points, r, step, w, _i, _j, _k, _l, _len, _len1, _len2, _len3, _len4, _m, _n, _name, _ref, _ref1, _ref2, _ref3, _ref4, _results;
      r = window.devicePixelRatio;
      w = this.canvas.width;
      h = this.canvas.height;
      step = 0.001;
      this.ctx.clearRect(0, 0, w, h);
      this.ctx.strokeStyle = '#D5E6F8';
      this.ctx.lineWidth = 1;
      this.ctx.beginPath();
      this.ctx.moveTo(0, 0.67 * h);
      this.ctx.lineTo(w, 0.67 * h);
      this.ctx.stroke();
      this.ctx.beginPath();
      this.ctx.moveTo(0, 0.34 * h);
      this.ctx.lineTo(w, 0.34 * h);
      this.ctx.stroke();
      this.tween.init();
      graphes = [];
      colors = ['#007EFF'];
      defaultColor = '#D5E6F8';
      colorI = 0;
      while (args = this.tween.next(step)) {
        for (i = _i = 1, _ref = args.length; 1 <= _ref ? _i <= _ref : _i >= _ref; i = 1 <= _ref ? ++_i : --_i) {
          graphes[_name = i - 1] || (graphes[_name] = {
            points: []
          });
          graphes[i - 1].points.push([args[0], args[i]]);
        }
        if (args[0] >= 1) {
          break;
        }
      }
      for (_j = 0, _len = graphes.length; _j < _len; _j++) {
        graph = graphes[_j];
        color = defaultColor;
        if (colorI < colors.length) {
          color = colors[colorI];
        }
        graph.color = color;
        graph.index = colorI;
        colorI += 1;
      }
      _ref1 = graphes.reverse();
      for (_k = 0, _len1 = _ref1.length; _k < _len1; _k++) {
        graph = _ref1[_k];
        points = graph.points;
        this.ctx.beginPath();
        this.ctx.strokeStyle = graph.color;
        this._drawCurve(points);
        if (graph.index === 0) {
          this.ctx.lineWidth = 2 * r;
        } else {
          this.ctx.lineWidth = 1 * r;
        }
        this.ctx.stroke();
      }
      if (this.points) {
        _ref2 = this.points;
        for (_l = 0, _len2 = _ref2.length; _l < _len2; _l++) {
          point = _ref2[_l];
          _ref3 = point.controlPoints;
          for (_m = 0, _len3 = _ref3.length; _m < _len3; _m++) {
            controlPoint = _ref3[_m];
            this.ctx.beginPath();
            this.ctx.strokeStyle = colors[0];
            this.ctx.lineWidth = 1;
            coords = this.pointCoordinates(point);
            this.ctx.moveTo(coords.x, coords.y);
            coordsControlPoint = this.pointCoordinates(controlPoint);
            this.ctx.lineTo(coordsControlPoint.x, coordsControlPoint.y);
            this.ctx.stroke();
          }
        }
        _ref4 = this.points;
        _results = [];
        for (_n = 0, _len4 = _ref4.length; _n < _len4; _n++) {
          point = _ref4[_n];
          this.ctx.beginPath();
          this.ctx.strokeStyle = this.selectedPoint === point ? 'red' : colors[0];
          this.ctx.fillStyle = 'white';
          this.ctx.lineWidth = 2 * r;
          coords = this.pointCoordinates(point);
          this.ctx.arc(coords.x, coords.y, 5 * r, 0, Math.PI * 2, true);
          this.ctx.fill();
          this.ctx.stroke();
          _results.push((function() {
            var _len5, _o, _ref5, _results1;
            _ref5 = point.controlPoints;
            _results1 = [];
            for (_o = 0, _len5 = _ref5.length; _o < _len5; _o++) {
              controlPoint = _ref5[_o];
              this.ctx.beginPath();
              this.ctx.strokeStyle = this.selectedPoint === controlPoint ? 'red' : colors[0];
              this.ctx.fillStyle = 'white';
              this.ctx.lineWidth = 1 * r;
              coords = this.pointCoordinates(controlPoint);
              this.ctx.arc(coords.x, coords.y, 3 * r, 0, Math.PI * 2, true);
              this.ctx.fill();
              _results1.push(this.ctx.stroke());
            }
            return _results1;
          }).call(this));
        }
        return _results;
      }
    };

    Graph.prototype.locationFromEvent = function(e) {
      return {
        x: e.layerX,
        y: e.layerY
      };
    };

    Graph.prototype.isLocationAroundCenter = function(location, center, size) {
      var r;
      r = window.devicePixelRatio;
      center = {
        x: center.x / r,
        y: center.y / r
      };
      return (location.x >= center.x - size / 2) && (location.x <= center.x + size / 2) && (location.y >= center.y - size / 2) && (location.y <= center.y + size / 2);
    };

    Graph.prototype.pointFromLocation = function(location) {
      var controlPoint, point, _i, _j, _len, _len1, _ref, _ref1;
      if (!this.points || this.points.length < 2) {
        return null;
      }
      _ref = this.points;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        point = _ref[_i];
        if (point !== this.points[0]) {
          if (this.isLocationAroundCenter(location, this.pointCoordinates(point), 14)) {
            return point;
          }
        }
        _ref1 = point.controlPoints;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          controlPoint = _ref1[_j];
          if (this.isLocationAroundCenter(location, this.pointCoordinates(controlPoint), 10)) {
            return controlPoint;
          }
        }
      }
      return null;
    };

    Graph.prototype.canvasMouseDown = function(e) {
      var location, point;
      location = this.locationFromEvent(e);
      point = this.pointFromLocation(location);
      this.selectedPoint = point;
      return this.draw();
    };

    Graph.prototype.canvasMouseMove = function(e) {
      var controlPoint, location, point, _i, _len, _ref;
      if (!this.selectedPoint) {
        return;
      }
      location = this.locationFromEvent(e);
      point = this.convertFromCoordinates(location);
      if (this.selectedPoint.controlPoints) {
        _ref = this.selectedPoint.controlPoints;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          controlPoint = _ref[_i];
          controlPoint.x += point.x - this.selectedPoint.x;
          controlPoint.y += point.y - this.selectedPoint.y;
        }
      }
      this.selectedPoint.x = point.x;
      this.selectedPoint.y = point.y;
      return this.draw();
    };

    Graph.prototype.canvasMouseUp = function(e) {
      this.selectedPoint = null;
      return this.draw();
    };

    Graph.prototype.pointCoordinates = function(point) {
      var h, w;
      w = this.canvas.width;
      h = this.canvas.height;
      return {
        x: point.x * w,
        y: (0.67 * h) - (point.y * 0.33 * h)
      };
    };

    Graph.prototype.convertFromCoordinates = function(location) {
      var h, r, w;
      r = window.devicePixelRatio;
      w = this.canvas.width;
      h = this.canvas.height;
      return {
        x: location.x / w * r,
        y: ((0.67 * h) - (location.y * r)) / (0.33 * h)
      };
    };

    Graph.prototype._drawCurve = function(points) {
      var h, point, r, t, v, w, _i, _len, _results;
      r = window.devicePixelRatio;
      w = this.canvas.width;
      h = this.canvas.height;
      _results = [];
      for (_i = 0, _len = points.length; _i < _len; _i++) {
        point = points[_i];
        t = point[0], v = point[1];
        if (t === 0) {
          _results.push(this.ctx.moveTo(t * w, h - ((0.33 + (v * 0.33)) * h)));
        } else {
          _results.push(this.ctx.lineTo(t * w, h - ((0.33 + (v * 0.33)) * h)));
        }
      }
      return _results;
    };

    return Graph;

  })();

  UIProperty = (function() {

    function UIProperty(options) {
      this.options = options != null ? options : {};
      this.setValue = __bind(this.setValue, this);

      this.el = document.createElement('div');
      this.label = document.createElement('label');
      this.label.innerHTML = this.options.property;
      this.valueEl = document.createElement('div');
      this.valueEl.classList.add('value');
      this.valueEl.classList.add(options.property);
      this.el.appendChild(this.label);
      this.el.appendChild(this.valueEl);
      this.valueEl.innerHTML = this.options.value;
    }

    UIProperty.prototype.setValue = function(value) {
      this.options.value = value;
      return this.valueEl.innerHTML = this.options.value;
    };

    return UIProperty;

  })();

  UISlider = (function() {

    function UISlider(options) {
      var _base, _base1;
      this.options = options != null ? options : {};
      this._windowMouseUp = __bind(this._windowMouseUp, this);

      this._windowMouseMove = __bind(this._windowMouseMove, this);

      this._controlMouseDown = __bind(this._controlMouseDown, this);

      this._updateLeftFromValue = __bind(this._updateLeftFromValue, this);

      this.value = __bind(this.value, this);

      (_base = this.options).min || (_base.min = 0);
      (_base1 = this.options).max || (_base1.max = 1000);
      if (this.options.value === void 0) {
        this.options.value = 10;
      }
      this.width = 205 - 11;
      this.el = document.createElement('div');
      this.label = document.createElement('label');
      this.label.innerHTML = this.options.property;
      this.valueEl = document.createElement('div');
      this.valueEl.classList.add('value');
      this.valueEl.classList.add(options.property);
      this.slider = document.createElement('div');
      this.slider.classList.add('slider');
      this.slider.classList.add(options.property);
      this.bar = document.createElement('div');
      this.bar.classList.add('bar');
      this.control = document.createElement('div');
      this.control.classList.add('control');
      this.slider.appendChild(this.bar);
      this.slider.appendChild(this.control);
      this.el.appendChild(this.label);
      this.el.appendChild(this.valueEl);
      this.el.appendChild(this.slider);
      this.valueEl.innerHTML = this.options.value;
      this._updateLeftFromValue();
      this.control.addEventListener('mousedown', this._controlMouseDown);
    }

    UISlider.prototype.value = function() {
      return this.options.value;
    };

    UISlider.prototype._updateLeftFromValue = function() {
      return this.control.style.left = (this.options.value - this.options.min) / (this.options.max - this.options.min) * this.width + "px";
    };

    UISlider.prototype._controlMouseDown = function(e) {
      this.dragging = true;
      this.startPoint = [e.pageX, e.pageY];
      this.startLeft = parseInt(this.control.style.left || 0);
      window.addEventListener('mousemove', this._windowMouseMove);
      return window.addEventListener('mouseup', this._windowMouseUp);
    };

    UISlider.prototype._windowMouseMove = function(e) {
      var dX, newLeft;
      if (!this.dragging) {
        return;
      }
      dX = e.pageX - this.startPoint[0];
      newLeft = this.startLeft + dX;
      if (newLeft > this.width) {
        newLeft = this.width;
      } else if (newLeft < 0) {
        newLeft = 0;
      }
      this.options.value = Math.round(newLeft / this.width * (this.options.max - this.options.min) + this.options.min);
      this.valueEl.innerHTML = this.options.value;
      if (typeof this.onUpdate === "function") {
        this.onUpdate();
      }
      return this.control.style.left = newLeft + "px";
    };

    UISlider.prototype._windowMouseUp = function(e) {
      this.dragging = false;
      window.removeEventListener('mousemove', this._windowMouseMove);
      return window.removeEventListener('mouseup', this._windowMouseUp);
    };

    return UISlider;

  })();

  Tools = (function() {
    var _this = this;

    function Tools() {}

    Tools.valuesFromURL = function() {
      var arg, k, query, url, v, values, _i, _len, _ref, _ref1;
      url = (document.location.toString() || '').split('#');
      values = {};
      if (url.length > 1) {
        query = url[1];
        _ref = query.split(',');
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          arg = _ref[_i];
          _ref1 = arg.split('='), k = _ref1[0], v = _ref1[1];
          values[k] = v;
        }
      }
      return values;
    };

    Tools.saveValues = function(args) {
      var argsString, currentURL, k, v;
      argsString = '';
      for (k in args) {
        v = args[k];
        if (argsString !== '') {
          argsString += ",";
        }
        argsString += "" + k + "=" + v;
      }
      currentURL = (document.location.toString() || '').split('#')[0];
      return document.location = currentURL + "#" + argsString;
    };

    return Tools;

  }).call(this);

  App = (function() {

    function App() {
      this.animate = __bind(this.animate, this);

      this.createDynamic = __bind(this.createDynamic, this);

      this.updateCode = __bind(this.updateCode, this);

      this.update = __bind(this.update, this);

      this.updateOptions = __bind(this.updateOptions, this);

      this.selectDidChange = __bind(this.selectDidChange, this);

      var aDynamicsClass, k, option, v, _i, _len, _ref;
      this.dynamicsClasses = [];
      for (k in Dynamics) {
        v = Dynamics[k];
        this.dynamicsClasses.push(v);
      }
      this.currentCircle = null;
      this.codeSection = document.querySelector('section.code');
      this.track = document.querySelector('div.track');
      this.select = document.querySelector('select.dynamics');
      this.dynamicsClass = this.dynamicsClasses[0];
      _ref = this.dynamicsClasses;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        aDynamicsClass = _ref[_i];
        if (aDynamicsClass.name === Tools.valuesFromURL().dynamic) {
          this.dynamicsClass = aDynamicsClass;
        }
        option = document.createElement('option');
        option.innerHTML = "Dynamics." + aDynamicsClass.name;
        option.value = aDynamicsClass.name;
        option.selected = aDynamicsClass === this.dynamicsClass;
        this.select.appendChild(option);
      }
      this.select.addEventListener('change', this.selectDidChange);
      this.graph = new Graph(document.querySelector('canvas'));
      this.sliders = [];
      this.properties = [];
      this.updateOptions();
      this.update();
    }

    App.prototype.selectDidChange = function() {
      var name;
      name = this.select.options[this.select.selectedIndex].value;
      this.dynamicsClass = eval("Dynamics." + name);
      this.updateOptions();
      return this.update();
    };

    App.prototype.updateOptions = function() {
      var config, property, slider, tweenOptionsEl, uiProperty, values, _i, _len, _ref, _ref1, _results;
      tweenOptionsEl = document.querySelector('.options');
      tweenOptionsEl.innerHTML = '';
      values = Tools.valuesFromURL();
      this.sliders = [];
      this.properties = [];
      this.points = null;
      _ref = this.dynamicsClass.properties;
      for (property in _ref) {
        config = _ref[property];
        if (config.type === 'points') {
          this.points = config["default"];
        } else if (config.editable === false) {
          uiProperty = new UIProperty({
            value: 'N/A',
            property: property
          });
          tweenOptionsEl.appendChild(uiProperty.el);
          this.properties.push(uiProperty);
        } else {
          slider = new UISlider({
            min: config.min,
            max: config.max,
            value: values[property] || config["default"],
            property: property
          });
          tweenOptionsEl.appendChild(slider.el);
          this.sliders.push(slider);
        }
      }
      _ref1 = this.sliders;
      _results = [];
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        slider = _ref1[_i];
        _results.push(slider.onUpdate = this.update);
      }
      return _results;
    };

    App.prototype.update = function() {
      var args, slider, uiProperty, _i, _j, _len, _len1, _ref, _ref1;
      args = {};
      _ref = this.sliders;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        slider = _ref[_i];
        args[slider.options.property] = slider.value();
      }
      if (this.dynamicsClass) {
        args['dynamic'] = this.dynamicsClass.name;
      }
      Tools.saveValues(args);
      if (this.animationTimeout) {
        clearTimeout(this.animationTimeout);
      }
      this.animationTimeout = setTimeout(this.animate, 400);
      this.createDynamic();
      this.graph.tween = this.dynamic.tween();
      this.graph.points = this.points;
      this.graph.draw();
      _ref1 = this.properties;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        uiProperty = _ref1[_j];
        uiProperty.setValue(this.dynamic.tween()[uiProperty.options.property]());
      }
      return this.updateCode();
    };

    App.prototype.updateCode = function() {
      var code, options, slider, translateX, _i, _len, _ref;
      translateX = this.dynamicsClass !== Dynamics.SelfSpring ? 350 : 50;
      options = '';
      _ref = this.sliders;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        slider = _ref[_i];
        if (options !== '') {
          options += ",\n";
        }
        options += "&nbsp;&nbsp;<strong>" + slider.options.property + "</strong>: " + (slider.value());
      }
      code = 'new <strong>Dynamics.' + this.dynamicsClass.name + '</strong>(document.getElementId("circle"), {\n&nbsp;&nbsp;<strong>translateX</strong>: 0\n}, {\n&nbsp;&nbsp;<strong>translateX</strong>: ' + translateX + '\n}, {\n' + options + '\n}).start();';
      return this.codeSection.innerHTML = code;
    };

    App.prototype.createDynamic = function() {
      var circle, from, options, shouldDeleteCircle, slider, to, _i, _len, _ref,
        _this = this;
      options = {};
      _ref = this.sliders;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        slider = _ref[_i];
        options[slider.options.property] = slider.value();
      }
      if (this.dynamicsClass !== Dynamics.SelfSpring) {
        from = {
          translateX: 0
        };
        to = {
          translateX: 350
        };
      } else {
        from = {
          translateX: 0
        };
        to = {
          translateX: 50
        };
      }
      if (!this.currentCircle) {
        this.currentCircle = document.createElement('div');
        this.currentCircle.classList.add('circle');
        this.currentCircle.addEventListener('click', function() {
          return _this.animate();
        });
        new Dynamics.Spring(this.currentCircle, {
          scale: 0
        }, {
          scale: 1
        }, {
          frequency: 0,
          friction: 600,
          anticipationStrength: 100,
          anticipationSize: 10,
          duration: 1000
        }).start();
        document.querySelector('section.demo').appendChild(this.currentCircle);
      }
      circle = this.currentCircle;
      shouldDeleteCircle = !this.dynamicsClass.returnsToSelf;
      options.complete = function() {
        if (!shouldDeleteCircle) {
          return;
        }
        _this.createDynamic();
        return new Dynamics.Spring(circle, {
          translateX: !_this.dynamicsClass.returnsToSelf ? 350 : 0,
          scale: 1
        }, {
          translateX: !_this.dynamicsClass.returnsToSelf ? 350 : 0,
          scale: 0
        }, {
          frequency: 0,
          friction: 600,
          anticipationStrength: 100,
          anticipationSize: 10,
          duration: 1000,
          complete: function() {
            return circle.parentNode.removeChild(circle);
          }
        }).start();
      };
      this.dynamic = new this.dynamicsClass(circle, from, to, options);
      if (this.dynamicsClass !== Dynamics.SelfSpring) {
        return this.track.classList.remove('tiny');
      } else {
        return this.track.classList.add('tiny');
      }
    };

    App.prototype.animate = function() {
      this.createDynamic();
      this.dynamic.start();
      if (!this.dynamicsClass.returnsToSelf) {
        return this.currentCircle = null;
      }
    };

    return App;

  })();

  document.addEventListener("DOMContentLoaded", function() {
    var app;
    return app = new App;
  }, false);

}).call(this);
